pragma solidity 0.8.14;

import "forge-std/Test.sol";
import "forge-std/console.sol";
import {RLPReader} from "@optimism-bedrock/rlp/RLPReader.sol";
import {RLPWriter} from "@optimism-bedrock/rlp/RLPWriter.sol";
import {MerkleTrie} from "@optimism-bedrock/trie/MerkleTrie.sol";

import {StorageProof, EventProof} from "src/libraries/StateProofHelper.sol";

contract StateProofHelperTest is Test {
    using RLPReader for bytes;
    using RLPReader for RLPReader.RLPItem;

    function testAccountProof() public pure {
        address contractAddress = 0x594bA7f22a52f58ba64a6093A2FC2e004b23A7BE;
        bytes32 stateRootHash =
            bytes32(0x1e1bd10bda86dc06b5704afd26df271d80071b7fe385e6d9107f10c8a6998898);

        bytes[] memory _proof = new bytes[](8);
        _proof[0] =
            hex"f90211a061e4915040960a5caba3ba34c71ee1cd6246025f716dc830b76938510231947ba08d1388b6665a61f8e22048042c4971dfc5fb15616dfe5b3e861d4341dd9ba06ca05cb9358e68d13badc5797470b418418b09a40a473aa222b87406d45b97528651a038f4ee954f6b79b9923d7934b9312c892622829481f1a613528f33ac1ba35ab5a007dc3b73232d1bd092ebdb54e127115fea93f405cf855f3eda83c838d0984feba080799e3ea519a7ccb0003242ea7b6ed3b3b2d8a43cf8150870238c452236e312a0613366cb2ba78e13b3f5af2f3330cf8609b454890332a7116a2c7edf210a1a66a06383dce0b38dfe74744deb322f694725e4c3d9168b80b106c7b58f205c3810b3a03b40a8e9d01bdafa0884f8d8e77eabdb96eb29d400c63a20eeec8e5417fece5fa08dae6ae2dda6ae7a597320e452827cecbdbca83295813f9f0e3277cad5588109a0d1cb0d29d1133687e0c94dc464fa395729f585a976b1904a2b67c690941ab9c0a0e4698914a7fc1008bf2420e71113198b402ce47a6b03afad219d676354d4ea5ba07f64bdc7861fe27a9e93641f6350cad83ff5bd1f2734a7fa39dce768259ffa25a03d6c7959009086f025017ac53bd255c21a37a1518add912fd6e46931d666bef0a0cd49504a1899af46d782b900b004a61ba7e282e96595570f08f988c935b09136a0860509ddb51d1fd215f950d22f29d584b484294c84ec621ddd0702fc61c21de180";
        _proof[1] =
            hex"f90211a06ea036715b3b940c58e0428a586f1963d8742a53df2a1148d0b9f064c235ae9aa0a7b4a63fb349ab1f190163fa4e8bdbf73fe8ed93e21f66535d7aa2db1b0009eba05f24da5f455f2952aedcf3fa47e2bec3a84407dff456df20847a21b5bec4f516a037e6467aece52f98d9ba9a5c6022e61ce69b06b0e7eb3565cc0cbaa898f034fda0284f6d57390a306d3af44df2b76c64a36d4fa7778c6c3ddbb6bbc5962d1f5240a065973d20c68907db64b2925a54c5d9d9d03b317a036b7ba7e9be29d95a190390a0ce88edcbae2a047f0a71262f674494d515f1f169f1ab2cb553f769b48956ae8ca0794d3b534babb32db120ba78865e7520038a06bd3e187ce1f1f2f77d9fe4bc5ba004b5b8893830fad80317502ddf99e10a2e3a2b90144351e674863f8ac0b8c0c3a0c5b2f468cbc0fce16e8075395dd87887c83f441a4c9ffcef8812de91dd14a621a0d677c79687f324fcc15e3b4d4005d1da7c6d9cb718b216a3dca2210816a30927a0d9deac0c4d31867f660fb68ad0890ea0cbdd5ed5a296c7360b3a9b220eadd90aa086cf39c1b3cc722d238ae9352272b187b51653c6138e7c5a8fc76ebf5c1ba737a00e48b533577fda39f447e07b2822d55713270bc035a135b8b059cae570349fbfa01fde554cda585532f5439e4c899fcb44ff1b8bed38c0cb3ed59cf8a92675f423a0bae59fcadeb2c11aeb0f460abbe4f6ad7126624e6e12a88f11198169ef1a010280";
        _proof[2] =
            hex"f90211a000f10c5e27fe30e081d2d8d21b1dc483c5e9731dd129019330afeea31bf3027ca08b4d3a600ecec9bd33738b9b3052d0cadb54cb0546499b9544b561699b0c3a95a021b8c364368e4047f3fd0ce9c0363eca9fa4b5c5d764f46b1dc4526ef9d91c20a0836a7cb1966221b3afe09f8dc5588afaffa5aced3c719de22d1ddd1ab2e5205aa05aa9f86efc7db6437c2c6373bb3a82a763e81d8b38140ec01bcaeb3b6cce52cca06f491f342646255cfe986c8c4b37fa9abedfed4192d4b402ed60b73b0c73c3aea07a8551ef240f9de41be2267e25f5b9d196ab3abef04661f78badd2debe34dcb9a0053d0f3ff22b8cdfc3cbf2eea12e2ff03fb21a6c9cf17f40c1b12214343db475a024ff57e515fea8dd26b54e0ba7eaafd2fd748e3c24936b152feb95b8dfb53251a03f7192f82b50b450c1f3ff6e0995e156f59241ea527a0f1375fa421b84b26561a06b10045198f037f1b78056a7f067f96ce2fba69de707d7e4455e30ecccea0729a020fb4b7031c139eeedef0a236cf688df5c427d00009f91e2ca5d66a561ea72c2a09e30ea1775458ba4492065f2a67a31622b8ec0e4f139ada3324e0c3371486994a0c4a2c811183d57f3e5cb21f024fce132cb6420ff0c9b2479a5ef91ac30c70805a09245df63db40bd648e0e1d0de3689486013b2e675c46ec876b5eca5e528fdb01a0103d79f816b0ce0d984589f5872038fa815a2f6a8c2fc7be3b621b9716be96a780";
        _proof[3] =
            hex"f90211a07d7d1e5c43dbe9a9bbe17d1caa370ee05bca8f34ef2e5d8c1e80a289401dce7aa099e495a1bce0b31d0496895e7f530b305e000ab810bf2f321ca964df3019babba031f5e5b18513571e4203dbadcf7d95e9f79eea40e2fd702d05c528dd92a8124fa07d11620d9e2a30cf61395f3048521404e37507e15fa98088853d4a0242370e86a028859efc98146eccd4a942099effc7f8c1928c2a11faac58939fe8d5c8aaf8a5a04fa32eed0b0343a00c7c65d177522cd1517da1b942545f2412bf99316905323aa066b2108fccb523836bf11f43f225acf383465b8f15e97b749a1e6ef048cc0b75a0c318af0786f6c4f098143c47c80a4030233ed0550bb8e84d2839c0a9c9335e03a0f3ca853a8d8a6c6248d7057204f0aa7af0de3b51de57b9cfe95876356fd8ba65a000eb11fd5ff40881627a5f6e3f80e2bd30256eda3fccf0136b644545dbc090b1a05835c476fac516570da884b65486db46017d59936c17239ef3540852470c2c13a02cf99702c880729f227b283291cb64d1b9b34a82041c5365d5fdb0c53578292aa06d082ebaf6b5d4d037a69f238152c022d74a6c47448aa5f7b53314dbedbb6b19a0b91615f35b9ebb8f443f3c5f526e0050d4605c21f2e5cd81922fa5e95d284dc3a0d44525e1f26e5ed38670bea83755b60c11f977b885d4c877387f94997c97b30fa0779b327a0b6fc4827eff68d5d4dd977f82d998ab19a34f1a0926f625996da47880";
        _proof[4] =
            hex"f90211a09925b76a16d98586e04941406a932190adda9cc6829629919a6f017af95fc60ea0a28bf9ac2fb2ca04e101979e2f5e96fbfc0f1ee2d263b00dea251d807f2ff790a0f04374728b7db397f63ae1c61e23659ba98530045a25c0eef2712e85d1b9432ea0aa618a5c24071fed324db74402b446c71c1a08b76419724acdc2aa8cabe2c126a0d5b3bf201bd34985015d13ab1ec5026583985935d0258824ed136db32d0d9305a028561432ee8a351969d3661b4bffb880892a35c3acf81f664f05fb4ce48a5628a07496029b042d3deaec0d18230fd5aced3a113329c1bba09c1f7108f6e7340db2a04286cb4bb0809aba549400ca3a39bb3791d872cb2349823c85043cfac01ccce3a084a0633e114bbe2e66e919026c0278bf7dbeedf9c560d4f270d17b4553ddaccfa03c320610d77338881732e6d870b6e3e48845da4d276fa1ac8fc572ff6ec138efa080e64709b5c42e8a1d468cfe822262056dd0aa73f2129990e6c0a0b31e57e5eda04fa919ae046ac7a740b5b30329a591b04143e2aa278b9a5a020f52cc14c0957ca010cfea4315620fbefa34105f148401da2b7124bc972d11cc885c3ee5bccd7762a02947144e0f220475b9c636bfbec4ad3eb719174f61d76bdd18816c82999d9165a071c4eeaa0505963f35ce7b670e55da22aa96e3910faa3cfc1358f2e8e78f6873a03f8b551680771ee28329253ba3de9100f0a2454502559000051bae37e2dfd36a80";
        _proof[5] =
            hex"f901f1a0c08ef8d5b88929e0c9aa960edae6ef1d73f18edad36d212861015fa3612897b2a08c379117765a1ab9851d6f572bd3672ea7691e5471e95ea54107dbbd1d7affe0a039bf8fb1faeebec1770d96d782b584246aa8b56abad54321a626252b04dfc1bba0f51daf5e60e8eb5362123bac917dd1fa4ca73696ff82efd6c499db1f59441ba4a083141291d6516095d3097416ae140f8759971c45e23cca49e3638f5f9c174233a0be89a5d7160906f23ad305c3596f4ab98cfd806efff5f2f85fbdc99d1d118211a0c0f37de4c75b2641a63db6d2fe8204ad103a44b63ba614490c673e60e30cda96a0ad7a49f4d7e3509a359157e42c4238e19d2c4dee7d5dc78c13dd23a8a8c53b3d80a0a170a7eaa23a1affb9ac93cd36e25bc82c3115247a6b85218262e75fcb8d8384a0e14231b6dcdc5be6af060ff1b9b7293c6ceb9ff056407b243fc2cfd29f2b0335a043a52c308fc24f490c5c405e518595c734b140a9737df4ad8176c13b30a505e2a04343025a067e12ba0c7d1af65cc7405af3139f7c3d81a32beb846191195c2defa0e513f7ffea8f703f5a982637bc1f37351c60f9d0ef025024d475592a8968f958a04a79ac0f0bc198ca431da041cc1d457ac2643d2c78ca9fbbbcdf458645a93b6da0c4be3d90016d6bdd1ae33af9beec641d257bb9deaf3c77b6337cdc76f5a6ef1180";
        _proof[6] =
            hex"f891808080a0bb35f3090f671ad51fa42325ea445891d10ceb4ed53c5364cbb173017435ffa780a0ebadc7f168d8343383d07d2ec6f9c8fb6c1af23d6493bc7081d165c1d04970e280a0df98e7b570759442a0ae3af93a33d901fcb0c491781d993c079df8c599a4a65980808080808080a024e47c7b5ece7a9afbb64bd1c466285fe7d1fa50bae9326fbb22ced0637f570680";
        _proof[7] =
            hex"f8669d38e910ed8df3e2c058bed6f4fc4218ba17cb2db5170708067c11995321b846f8440180a08cccc66b89addd7131562996d3b2fff89ce775e940e44a3618cbdf62389549d3a0add804b4a1208bbc99f66d37e5917a1e9c01d95e10ade06ac19d07a535ea42ce";

        bytes32 storageRoot = StorageProof.getStorageRoot(_proof, contractAddress, stateRootHash);
        require(storageRoot == 0x8cccc66b89addd7131562996d3b2fff89ce775e940e44a3618cbdf62389549d3);
    }

    function testReceiptProof() public pure {
        bytes32 receiptsRoot = 0x05911bffdb32343df6d8af53971ade6b8959e1b06ad994715a8080524a2875d2;
        bytes memory key = hex"28";
        bytes[] memory proof = new bytes[](3);
        proof[0] =
            hex"f8f1a0f90859a9e586a4c8e66aa9f1d32a4931f1154c77ec712fc9ecc99a4ed776326ea06a557db722597a9aeda7c98bb7ffe686142f7ac18cc9c8dfb25d22031bc5f6b0a06c00bc782e736cf97c33ad6d7e6bd2fd39fa279fee4bc305a9a117865942a2d1a0a8748472369eb2aa13896d4affa91a3a9228164479c2bd8031d386e270b0b302a084893bd2913ed19cf8c3f6dff9ae3b185da5d48d8befacabcb3a0c687b972c79a09eb3558591217617199301798ae54f7a68d8a9d40f71e69ee9771be63ab3cd138080a0c1ae84c085bcad8ac7da99930f744eb6299213b996578e541639a647aed4952f8080808080808080";
        proof[1] =
            hex"f90211a01ae3959b059ad75342767a69756a715eaa78a197e8e50f05ca72d0a30c124623a0c506f11780d11f404615fd9b8d6469b894c864faee83e65dfe53432cbd8738c2a0edcfb8698c0c16908eddeeec015dc13d411567425ba8cca866029ce76c338ccea0ae070ce274ca2f45e789eb6b3ce73ff75862f1d1a486b89fd40c9af46ec5ecd0a0e25336ce8790d2e819346a186f64c7b6e5149c296d70974fe0e5590506274a0fa038fca8cb5118c4752c08aab2773377599fd3e903ebd095a6a4fd57cb54bb51cca018424f39f11e17dff48ed7a2ce79aa5534d0baf80e4243ed49afc09993d3e6b5a06034cd832ee0f9afa604e52dd36194afcfb490d6e0eec948279f13ca70f3f7a3a01de767efc90eaf623ba1d5e0590cffcdca7a46309d503859f6244e9b32c05cd7a06b1d893b5d8c89e8a4fdc7f78ef58330423581bc22d1475d0cc412b242fc3f4aa02e0fa09c622d4501e090b99bba2d6f3e73e1aba6c9d10c7fefe7d30387d6fee7a0a79b0390f680dd07adc82cec55240eab8da8393c53a291b7049b1b456315a210a01db287df72ab4378d8ad8176457d088f588611eff06b827b3c0d707b9f9228cca05f9c098db814b8531ed8ce9dc05551aa2731b31753af975265ea2eefd7d71c9ca02d960af158338798d676da70e5c93f08ab1364128e31c32b3ad748bd30f37e73a06b767cebaba781d29c0e85ebfe2a9318a44e8408cda2bfef3e299f9b08b6842d80";
        proof[2] =
            hex"f9050c20b9050802f905040184016ebfaeb901004000000000010000000000000100000000000200000000000000000000000000000080000000800000000000000000002000000000000000000000000020000000000000000000000000000c800000020000000000000000000000000000000040000000000000000000000000000200000000000000002000000010800000000000000000000000000000080000000000001080000000000000000000000100020000000004000000000000020000000000000000000000000000000000000000000002000000000001000001000020000000000000000000000000000000000018000000000000004000000000000000200000000000000400000000000000f903f8f89b9445cd94330ac3aea42cc21cf9315b745e27e768bdf863a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05a0000000000000000000000000e8a7f02499402a72532669fdcc8d70674351b23da00000000000000000000000000000000000000000000000000000000000000000f89b9445cd94330ac3aea42cc21cf9315b745e27e768bdf863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05a0000000000000000000000000e8a7f02499402a72532669fdcc8d70674351b23da00000000000000000000000000000000000000000000000000000000000000002f901fd9468787ab0ca5a4a8cc82177b4e4f206765ce39956f863a069fba49bf5354b0f1c560ef32d7525874d05e65452e997b5556a9dedb5d7576fa0000000000000000000000000000000000000000000000000000000000000003aa03945f27c4f49fbcfa635ea64f6996759b49f07c8e1912494bce5ad187f99d53bb9018000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000e8a7f02499402a72532669fdcc8d70674351b23d0000000000000000000000005ae47c1ee4bef58291574dad5e11aece2f79e98b0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000c35000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05000000000000000000000000000000000000000000000000000000000000000200000000000000000000000045cd94330ac3aea42cc21cf9315b745e27e768bdf8bc94e8a7f02499402a72532669fdcc8d70674351b23df863a04e0b8b96097e818e136165437b47119a1f95ecfae8c068a60bd0a1394b238ef4a0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05a0000000000000000000000000c13410f2d4ebac009f78eaa8c496460263867c05b840000000000000000000000000000000000000000000000000000000000000000200000000000000000000000045cd94330ac3aea42cc21cf9315b745e27e768bd";
        uint256 logIndex = 2;
        address claimedEmitter = 0x68787ab0Ca5A4a8CC82177B4E4f206765Ce39956;

        bytes32 nonce = EventProof.getEventTopic(
            proof,
            receiptsRoot,
            key,
            logIndex,
            claimedEmitter,
            keccak256("SentMessage(uint256,bytes32,bytes)"),
            1
        );
        require(uint256(nonce) == 58);

        bytes32 messageRoot = EventProof.getEventTopic(
            proof,
            receiptsRoot,
            key,
            logIndex,
            claimedEmitter,
            keccak256("SentMessage(uint256,bytes32,bytes)"),
            2
        );
        require(messageRoot == 0x3945f27c4f49fbcfa635ea64f6996759b49f07c8e1912494bce5ad187f99d53b);
    }
}
